<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La Perla del Caribe</title>
  <style>
    :root{
      --bg-1: #05020a;
      --neon-pink: #ff2fa6;
      --neon-cyan: #1fe6ff;
      --neon-orange: #ff9f1c;
      --neon-green: #23ff88;
      --card: rgba(255,255,255,0.04);
      --glass: rgba(255,255,255,0.03);
      --muted: #cbd5e1;
      --accent: var(--neon-pink);
    }

    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(ellipse at 10% 10%, rgba(31,230,255,0.06), transparent 10%),
                  radial-gradient(ellipse at 90% 80%, rgba(255,47,166,0.04), transparent 10%),
                  linear-gradient(180deg,#02030a 0%, #07060b 100%);
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      color: #f6f7fb;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      justify-content:center;
      padding:1rem;
    }

    .app {
      width:100%;
      max-width:760px;
    }

    header.app-header{
      display:flex;
      align-items:center;
      gap:1rem;
      margin-bottom:0.8rem;
    }
    .logo {
      width:84px;
      height:84px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6), 0 0 18px rgba(31,230,255,0.06) inset;
      overflow:hidden;
      border: 2px solid rgba(255,255,255,0.04);
    }
    .logo img { width:100%; height:100%; object-fit:cover; filter: saturate(1.05) contrast(1.02); }

    .title {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    h1{
      margin:0;
      font-size:1.25rem;
      letter-spacing:0.6px;
      text-shadow: 0 2px 12px rgba(31,230,255,0.08);
    }
    .subtitle{
      font-size:0.9rem;
      color:var(--muted);
    }

    /* layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:1rem;
      align-items:start;
    }

    /* Left: menu */
    .panel {
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:12px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.03);
    }

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .section-title strong{ font-size:1rem; color:var(--neon-cyan); text-shadow: 0 4px 20px rgba(31,230,255,0.06); }

    .button-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:0.5rem;
    }

    .product-btn{
      padding:14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
      font-size:1rem;
      color: #06060b;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
      transition: transform .08s ease, box-shadow .12s ease;
      user-select:none;
    }
    .product-btn:active { transform: translateY(1px) scale(.998); }

    /* Colors inspired by the neon image */
    .btn-neon-pink { background: linear-gradient(180deg, var(--neon-pink), #ff1f8f); color: #050005; }
    .btn-neon-cyan { background: linear-gradient(180deg, var(--neon-cyan), #00c8e6); color:#031018; }
    .btn-neon-orange { background: linear-gradient(180deg, var(--neon-orange), #ff7a1f); color:#170600; }
    .btn-neon-green { background: linear-gradient(180deg, var(--neon-green), #0fe66d); color:#051107; }

    /* right column: ticket */
    .ticket {
      border-radius:12px;
      padding:12px;
      background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.03);
      position:relative;
    }
    .ticket h2 { margin:0 0 8px 0; font-size:1rem; color:var(--neon-orange); text-shadow:0 4px 18px rgba(255,159,28,0.06); }

    #ticket-lists { font-family:monospace; white-space:pre-wrap; color:#e6eef6; margin-bottom:8px; min-height:120px; font-size:1rem; }
    #total { font-size:1.0rem; font-weight:700; color:var(--neon-green); margin-bottom:8px; }

    .remove-item { background:none; border: none; color: #ff9fb3; cursor:pointer; font-weight:bold; margin-left:8px; }

    .controls { display:flex; gap:8px; flex-direction:column; }
    .controls .row { display:flex; gap:8px; }

    .big-btn {
      padding: 12px 14px;
      border-radius:10px;
      border:none;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 8px 22px rgba(0,0,0,0.5);
    }
    #print { background:linear-gradient(180deg,var(--neon-cyan),#00a9d6); color:#001216; }
    #reset { background:linear-gradient(180deg,var(--neon-pink),#ff1f8f); color:#120010; }

    input[type="number"]{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
      color: #eaf6ff;
      font-size:1rem;
    }

    .small { font-size:0.85rem; color:var(--muted); }

    /* responsive */
    @media (max-width:880px){
      .grid{ grid-template-columns: 1fr; }
      .ticket { order:2; margin-top:0.6rem; }
    }

  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="logo">
        <!-- Reemplaza src.jpg por tu logo si quieres -->
        <img src="src.jpg" alt="La Perla logo" />
      </div>
      <div class="title">
        <h1>La Perla del Caribe Coctelería</h1>
      </div>
    </header>

    <main class="grid">
      <!-- MENU -->
      <div class="panel">
        <div class="section-title"><strong>Menú La Perla Pub</strong></div>

        <div class="button-grid" id="menuMain">
          <button class="product-btn btn-neon-green" onclick="addProduct('Copa normal', 8.00)">Copa normal - 8,00€</button>
          <button class="product-btn btn-neon-green" onclick="addProduct('Copa premium', 10.00)">Copa premium - 10,00€</button>

          <button class="product-btn btn-neon-green" onclick="addProduct('Redbull +1', 1.00)">Redbull +1€ - 1,00€</button>

          <button class="product-btn btn-neon-green" onclick="addProduct('Cóctel', 8.00)">Cóctel - 8,00€</button>
          <button class="product-btn btn-neon-green" onclick="addProduct('Mojito con botella de Jäger', 10.00)">Mojito + Jäger - 10,00€</button>

          <button class="product-btn btn-neon-cyan" onclick="addProduct('Cerveza tercio normal', 3.50)">Cerveza tercio normal - 3,50€</button>
          <button class="product-btn btn-neon-cyan" onclick="addProduct('Cerveza tercio 1906', 4.00)">Cerveza tercio 1906 - 4,00€</button>
          <button class="product-btn btn-neon-cyan" onclick="addProduct('Tercios importadas', 4.50)">Tercios importadas - 4,50€</button>

          <button class="product-btn btn-neon-cyan" onclick="addProduct('Caña normal', 3.00)">Caña normal - 3,00€</button>
          <button class="product-btn btn-neon-cyan" onclick="addProduct('Caña 1906', 3.50)">Caña 1906 - 3,50€</button>

          <button class="product-btn btn-neon-orange" onclick="addProduct('Refresco', 3.00)">Refresco - 3,00€</button>
          <button class="product-btn btn-neon-orange" onclick="addProduct('Redbull', 3.50)">Redbull - 3,50€</button>
          <button class="product-btn btn-neon-orange" onclick="addProduct('Agua', 2.50)">Agua - 2,50€</button>

          <button class="product-btn btn-neon-pink" onclick="addProduct('Chupito', 3.00)">Chupito - 3,00€</button>
          <button class="product-btn btn-neon-pink" onclick="addProduct('Cubo', 15.00)">Cubo - 15,00€</button>
        </div>
       <br>
        <div class="section-title"><strong>OFERTA ESPECIAL JUEVES UNIVERSITARIO</strong></div>
        <div class="button-grid" id="menuOffer">
          <button class="product-btn btn-neon-green" onclick="addProduct('Copa normal (Promo Jue)', 6.00)">Copa normal - 6,00€</button>
          <button class="product-btn btn-neon-cyan" onclick="addProduct('Caña normal (Promo Jue)', 2.00)">Caña normal - 2,00€</button>
        </div>
      </div>

      <!-- TICKET -->
      <aside class="ticket">
        <h2>Ticket</h2>
        <div id="ticket-lists">(aún no hay productos)</div>
        <div id="total">Total: 0,00€</div>

        <div style="margin-bottom:8px;">
          <label class="small">Pago cliente (€)</label>
          <input type="number" id="pagoCliente" placeholder="50,00" oninput="calcularCambio()" step="0.01" />
          <div id="cambio" class="small" style="margin-top:6px;color:var(--neon-green);font-weight:700;"></div>
        </div>

        <div class="controls">
          <div class="row">
            <button id="print" class="big-btn" onclick="printTickets()">Imprimir (RAWBT / alternativa)</button>
            <button id="copy" class="big-btn" onclick="copyTicketText()">Copiar ticket</button>
            <button id="reset" class="big-btn" onclick="resetTickets()">Reiniciar</button>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // ---------------------------
    // Configuración
    // ---------------------------
    const IVA_RATE = 0.21; // Cambia aquí si tu IVA no es 21% (ej: 0.10 para 10%)

    // Datos del ticket
    let ticket = [];

    // formateo euros ES
    function fmt(eur){
      // Aseguramos número
      const n = Number(eur) || 0;
      return n.toLocaleString('es-ES', {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    // Añadir producto
    function addProduct(name, price) {
      price = parseFloat(price) || 0;
      const existing = ticket.find(p => p.name === name);
      if (existing) existing.qty++;
      else ticket.push({name, price, qty: 1});
      updateDisplay();
      calcularCambio();
    }

    // Quitar producto (disminuye qty o lo elimina)
    function removeProduct(name) {
      const idx = ticket.findIndex(p => p.name === name);
      if (idx === -1) return;
      if (ticket[idx].qty > 1) ticket[idx].qty--;
      else ticket.splice(idx,1);
      updateDisplay();
      calcularCambio();
    }

    // Actualizar visual del ticket (lista + desgloses)
    function updateDisplay() {
      const total = ticket.reduce((s,p) => s + p.price * p.qty, 0);

      // Desglosamos base imponible e IVA (precios incluyen IVA)
      const base = total / (1 + IVA_RATE);
      const iva = total - base;

      if (ticket.length === 0){
        document.getElementById('ticket-lists').textContent = '(aún no hay productos)';
      } else {
        // cada producto en su propia línea
        let html = '';
        ticket.forEach(p => {
          html += `<span style="font-family:monospace;">${p.name} x${p.qty} - ${fmt(p.price * p.qty)}€</span> <button class="remove-item" onclick="removeProduct('${p.name.replace(/'/g,"\\'")}')">❌</button><br>`;
        });
        document.getElementById('ticket-lists').innerHTML = html;
      }

      // mostramos subtotal (base), IVA y total en el contenedor #total
      document.getElementById('total').innerHTML =
        `Base imponible: ${fmt(base)}€<br>IVA (${Math.round(IVA_RATE*100)}%): ${fmt(iva)}€<br><strong>Total: ${fmt(total)}€</strong>`;
    }

    // Construye texto de ticket con saltos de línea claros
    function generateTicketText(items, pagoClienteVal = null, vatRate = IVA_RATE) {
      const ahora = new Date();
      const fecha = ahora.toLocaleString('es-ES');
      const total = items.reduce((s,p)=> s + p.price * p.qty, 0);
      const base = total / (1 + vatRate);
      const iva = total - base;

      let lines = [];
      lines.push('*** La Perla del Caribe ***');
      lines.push(`Fecha: ${fecha}`);
      lines.push(''); // separación
      lines.push('Productos:');
      lines.push('-----------------------------');

      items.forEach(p => {
        const subtotal = (p.price * p.qty);
        lines.push(`${p.name} x${p.qty}  ${fmt(subtotal)}€`);
      });

      lines.push('-----------------------------');
      lines.push(`Base imponible: ${fmt(base)}€`);
      lines.push(`IVA (${Math.round(vatRate*100)}%): ${fmt(iva)}€`);
      lines.push(`TOTAL: ${fmt(total)}€`);

      if (pagoClienteVal !== null && pagoClienteVal !== '') {
        const pago = parseFloat(pagoClienteVal) || 0;
        const cambio = pago - total;
        lines.push(`Pago: ${fmt(pago)}€`);
        lines.push(`Cambio: ${fmt(cambio)}€`);
      }

      lines.push('');
      lines.push('Gracias por su visita!');
      return lines.join('\n');
    }

    // Seguridad: escapar HTML para fallback window
    function escapeHtml(unsafe) {
      return String(unsafe).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // Copiar texto al portapapeles (con fallback)
    function copyToClipboard(txt){
      if (navigator.clipboard && window.isSecureContext) {
        return navigator.clipboard.writeText(txt);
      } else {
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); } catch(e){ console.warn('copy fallback failed', e); }
        ta.remove();
        return Promise.resolve();
      }
    }

    // Copiar desde UI
    function copyTicketText(){
      if (ticket.length === 0){ alert('No hay productos en el ticket.'); return; }
      const pagoVal = document.getElementById('pagoCliente').value || null;
      const text = generateTicketText(ticket, pagoVal);
      copyToClipboard(text).then(()=> alert('Ticket copiado al portapapeles.'));
    }

    // Intentar mandar a RAWBT con varios fallbacks
    function openRawbt(text) {
      const encoded = encodeURIComponent(text);

      const candidates = [
        `rawbt:${encoded}`,
        `rawbt:=${encoded}`,
        `rawbt://print?text=${encoded}`,
        `rawbt://?text=${encoded}`
      ];

      // Intentamos redirigir al protocolo. Si no funciona, fallback a nueva ventana o copia
      for (let i = 0; i < candidates.length; i++){
        try {
          window.location.href = candidates[i];
          return;
        } catch(e){
          /* seguir */
        }
      }

      // fallback: abrir nueva ventana con <pre> para preservar saltos de línea
      const w = window.open('', '_blank');
      if (w){
        w.document.write('<pre style="font-family:monospace;padding:12px;">' + escapeHtml(text) + '</pre>');
        w.document.title = 'Ticket — copiar/pegar';
      } else {
        // si popup bloqueado, copiamos al portapapeles
        copyToClipboard(text);
        alert('Texto de ticket copiado al portapapeles (fallback).');
      }
    }

    // Imprimir botón: genera texto y llama al openRawbt
    function printTickets(){
      if (ticket.length === 0) { alert('No hay productos seleccionados.'); return; }
      const pagoVal = document.getElementById('pagoCliente').value || null;
      const text = generateTicketText(ticket, pagoVal);
      openRawbt(text);
    }

    // Reiniciar ticket
    function resetTickets(){
      if (!confirm('¿Reiniciar ticket actual?')) return;
      ticket = [];
      document.getElementById('pagoCliente').value = '';
      document.getElementById('cambio').textContent = '';
      updateDisplay();
    }

    // Calcular y mostrar cambio (usa total con IVA incluido)
    function calcularCambio(){
      const pagoStr = document.getElementById('pagoCliente').value;
      const pago = parseFloat(pagoStr);
      const total = ticket.reduce((s,p) => s + p.price * p.qty, 0);
      const div = document.getElementById('cambio');
      if (!isNaN(pago)){
        const cambio = pago - total;
        if (cambio < 0) { div.textContent = `Faltan ${fmt(Math.abs(cambio))}€`; div.style.color='salmon'; }
        else { div.textContent = `Cambio: ${fmt(cambio)}€`; div.style.color='var(--neon-green)'; }
      } else div.textContent = '';
    }

    // Inicializar visual
    updateDisplay();
  </script>
</body>
</html>
