<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La Perla del Caribe - TPV (corregido)</title>
  <style>
    :root{--neon-pink:#ff2fa6;--neon-cyan:#1fe6ff;--neon-green:#23ff88;--muted:#cbd5e1;}
    html,body{height:100%;margin:0;background:#07060b;font-family:"Segoe UI",Roboto,Arial,sans-serif;color:#f6f7fb;display:flex;justify-content:center;padding:1rem;}
    .app{width:100%;max-width:980px;}
    header{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:12px;}
    .panel{background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03);}
    .button-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;}
    .product-btn{padding:10px;border-radius:8px;border:none;cursor:pointer;font-weight:700;color:#06060b;box-shadow:0 6px 18px rgba(0,0,0,0.3);}
    .btn-neon-green{background:linear-gradient(180deg,#23ff88,#0fe66d);} .btn-neon-cyan{background:linear-gradient(180deg,#1fe6ff,#00c8e6);} .btn-neon-orange{background:linear-gradient(180deg,#ff9f1c,#ff7a1f);} .btn-neon-pink{background:linear-gradient(180deg,#ff2fa6,#ff1f8f);}
    .ticket{border-radius:10px;padding:12px;background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.03);}
    #ticket-lists{font-family:monospace;white-space:pre-wrap;min-height:110px;margin-bottom:8px;color:#e6eef6;}
    #total{font-weight:700;color:var(--neon-green);margin-bottom:8px;}
    .small{font-size:0.85rem;color:var(--muted);}
    .history{max-height:300px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);}
    table{width:100%;border-collapse:collapse;font-size:0.9rem}
    th,td{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
    .action-btn{padding:6px;border-radius:6px;border:none;cursor:pointer;font-weight:700}
    @media(max-width:920px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="width:64px;height:64px;background:#111;border-radius:8px;display:flex;align-items:center;justify-content:center">Logo</div>
      <div>
        <h2 style="margin:0">La Perla del Caribe — TPV</h2>
        <div class="small">Corregido: compatibilidad WebView</div>
      </div>
    </header>

    <main class="grid">
      <div class="panel">
        <div style="margin-bottom:8px;"><strong>Menú</strong></div>
        <div class="button-grid" id="menuMain">
          <!-- ahora usamos data-* para evitar problemas de comillas -->
          <button class="product-btn btn-neon-green" data-name="Copa normal" data-price="8.00">Copa normal - 8,00€</button>
          <button class="product-btn btn-neon-green" data-name="Copa premium" data-price="10.00">Copa premium - 10,00€</button>
          <button class="product-btn btn-neon-green" data-name="Redbull +1" data-price="1.00">Redbull +1 - 1,00€</button>
          <button class="product-btn btn-neon-green" data-name="Cóctel" data-price="8.00">Cóctel - 8,00€</button>
           <button class="product-btn btn-neon-green" data-name="Mojito con botella de Jäger" data-price="10.00">Mojito + Jäger - 10,00€</button>
          <button class="product-btn btn-neon-cyan" data-name="Cerveza tercio normal" data-price="3.50">Tercio normal - 3,50€</button>
          <button class="product-btn btn-neon-cyan" data-name="Cerveza tercio 1906/corona" data-price="4.00">Tercio 1906/Corona - 4,00€</button>
           <button class="product-btn btn-neon-cyan" data-name="Cerveza importada" data-price="4.50">Tercio importado - 4,50€</button>
          <button class="product-btn btn-neon-cyan" data-name="Caña normal" data-price="3.00">Caña normal - 3,00€</button>
          <button class="product-btn btn-neon-cyan" data-name="Caña 1906" data-price="3.50">Caña 1906 - 3,50€</button>
          <button class="product-btn btn-neon-orange" data-name="Refresco" data-price="3.00">Refresco - 3,00€</button>
          <button class="product-btn btn-neon-orange" data-name="Redbull" data-price="3.50">Redbull - 3,50€</button>
          <button class="product-btn btn-neon-pink" data-name="Chupito" data-price="3.00">Chupito - 3,00€</button>
          <button class="product-btn btn-neon-pink" data-name="Cubo" data-price="15.00">Cubo - 15,00€</button>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
          <div style="flex:1;min-width:140px;">
            <label class="small">Pago cliente (€)</label>
            <input type="number" id="pagoCliente" placeholder="50,00" step="0.01" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:#eaf6ff;">
          </div>
        </div>

        <div style="margin-top:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <strong>Historial de tickets</strong>
            <div>
              <button class="action-btn" id="clearHistoryBtn">Limpiar</button>
              <button class="action-btn" id="exportCSVBtn">Exportar CSV</button>
              <button class="action-btn" id="exportJSONBtn">JSON</button>
            </div>
          </div>
          <div class="history" id="historyContainer"></div>
        </div>
      </div>

      <aside class="ticket panel">
        <h3 style="margin:0 0 8px 0">Ticket</h3>
        <div id="ticket-lists">(aún no hay productos)</div>
        <div id="total">Total: 0,00€</div>
        <div id="cambio" class="small" style="margin-bottom:8px;color:var(--neon-green);font-weight:700;"></div>

        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <button class="action-btn" id="printSaveBtn">Imprimir & Guardar</button>
          <button class="action-btn" id="copyBtn">Copiar</button>
        </div>

        <div class="small">Al pulsar <strong>Imprimir & Guardar</strong> el ticket se guarda en el historial (localStorage).</div>
      </aside>
    </main>
  </div>

  <script>
    // ---------- Config ----------
    var IVA_RATE = 0.21;
    var HISTORY_KEY = 'lp_ticket_history_v1';
    var ticket = [];

    // Compat: function de escape (no replaceAll)
    function escapeHtmlCompat(s){
      if (s === null || s === undefined) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function fmt(eur){
      var n = Number(eur) || 0;
      return n.toLocaleString('es-ES', {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    // Añadir producto (usado desde listeners)
    function addProduct(name, price){
      price = parseFloat(price) || 0;
      var existing = null;
      for (var i=0;i<ticket.length;i++){ if (ticket[i].name === name){ existing = ticket[i]; break; } }
      if (existing) existing.qty++;
      else ticket.push({name: name, price: price, qty: 1});
      updateDisplay();
      calcularCambio();
    }

    function removeProduct(name){
      for (var i=0;i<ticket.length;i++){
        if (ticket[i].name === name){
          if (ticket[i].qty > 1) ticket[i].qty--;
          else ticket.splice(i,1);
          break;
        }
      }
      updateDisplay();
      calcularCambio();
    }

    function updateDisplay(){
      var total = 0;
      for (var i=0;i<ticket.length;i++) total += ticket[i].price * ticket[i].qty;
      var base = total / (1 + IVA_RATE);
      var iva = total - base;

      var lists = document.getElementById('ticket-lists');
      if (ticket.length === 0){
        lists.textContent = '(aún no hay productos)';
      } else {
        var html = '';
        for (var i=0;i<ticket.length;i++){
          var p = ticket[i];
          html += '<span style="font-family:monospace;">' + escapeHtmlCompat(p.name) + ' x' + p.qty + ' - ' + fmt(p.price * p.qty) + '€</span>';
          html += ' <button class="action-btn" onclick="removeProduct(\'' + p.name.replace(/'/g,"\\'") + '\')">❌</button><br>';
        }
        lists.innerHTML = html;
      }

      var totalEl = document.getElementById('total');
      totalEl.innerHTML = 'Base imponible: ' + fmt(base) + '€<br>IVA (' + Math.round(IVA_RATE*100) + '%): ' + fmt(iva) + '€<br><strong>Total: ' + fmt(total) + '€</strong>';
    }

    // Generar texto del ticket
    function generateTicketText(items, pagoClienteVal){
      var now = new Date();
      var fecha = now.toLocaleString('es-ES');
      var total = 0;
      for (var i=0;i<items.length;i++) total += items[i].price * items[i].qty;
      var base = total / (1 + IVA_RATE);
      var iva = total - base;

      var lines = [];
      lines.push('*** La Perla del Caribe ***');
      lines.push('Fecha: ' + fecha);
      lines.push('');
      lines.push('Productos:');
      lines.push('-----------------------------');
      for (var i=0;i<items.length;i++){
        var p = items[i];
        lines.push(p.name + ' x' + p.qty + '  ' + fmt(p.price * p.qty) + '€');
      }
      lines.push('-----------------------------');
      lines.push('Base imponible: ' + fmt(base) + '€');
      lines.push('IVA (' + Math.round(IVA_RATE*100) + '%): ' + fmt(iva) + '€');
      lines.push('TOTAL: ' + fmt(total) + '€');

      if (pagoClienteVal !== null && pagoClienteVal !== ''){
        var pago = parseFloat(pagoClienteVal) || 0;
        var cambio = pago - total;
        lines.push('Pago: ' + fmt(pago) + '€');
        lines.push('Cambio: ' + fmt(cambio) + '€');
      }
      lines.push('');
      lines.push('Gracias por su visita!');
      return lines.join('\n');
    }

    // ---------- Historial ----------
    function getHistory(){
      try {
        var raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch(e){
        console.warn('Error leyendo historial', e);
        return [];
      }
    }

    function saveHistory(history){
      try { localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); }
      catch(e){ console.warn('Error guardando historial', e); alert('No se pudo guardar en localStorage.'); }
    }

    function saveTicketToHistory(items, pagoClienteVal){
      var now = new Date();
      var id = String(now.getTime());
      var total = 0;
      for (var i=0;i<items.length;i++) total += items[i].price * items[i].qty;
      var base = total / (1 + IVA_RATE);
      var iva = total - base;
      var pago = (pagoClienteVal !== null && pagoClienteVal !== '') ? parseFloat(pagoClienteVal) : null;
      var cambio = (pago !== null) ? (pago - total) : null;

      var itemsTextArr = [];
      for (var i=0;i<items.length;i++) itemsTextArr.push(items[i].name + ' x' + items[i].qty + ' (' + fmt(items[i].price) + 'u)');
      var itemsText = itemsTextArr.join(' ; ');

      var entry = {
        id: id,
        fechaISO: now.toISOString(),
        fechaLegible: now.toLocaleString('es-ES'),
        items: items.map(function(p){ return {name:p.name, price:p.price, qty:p.qty}; }),
        itemsText: itemsText,
        total: Number(total.toFixed(2)),
        base: Number(base.toFixed(2)),
        iva: Number(iva.toFixed(2)),
        pago: pago !== null ? Number(pago.toFixed(2)) : null,
        cambio: cambio !== null ? Number(cambio.toFixed(2)) : null
      };

      var history = getHistory();
      history.unshift(entry);
      var MAX = 1000;
      if (history.length > MAX) history.splice(MAX);
      saveHistory(history);
      renderHistory();
      return entry;
    }

    function deleteHistoryItem(id){
      var history = getHistory();
      history = history.filter(function(h){ return h.id !== id; });
      saveHistory(history);
      renderHistory();
    }

    function clearHistoryConfirm(){
      if (!confirm('¿Borrar todo el historial?')) return;
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
    }

    function renderHistory(){
      var container = document.getElementById('historyContainer');
      var history = getHistory();
      if (!history || history.length === 0){
        container.innerHTML = '<div class="small">No hay tickets guardados.</div>';
        return;
      }
      var html = '<table><thead><tr><th>Fecha</th><th>Items</th><th>Total</th><th>Pago</th><th></th></tr></thead><tbody>';
      for (var i=0;i<history.length;i++){
        var e = history[i];
        var pagoStr = '-';
        if (e.pago !== null) pagoStr = fmt(e.pago) + '€' + (e.cambio !== null ? ' (cambio ' + fmt(e.cambio) + '€)' : '');
        html += '<tr><td style="white-space:nowrap;">' + escapeHtmlCompat(e.fechaLegible) + '</td><td>' + escapeHtmlCompat(e.itemsText) + '</td><td>' + fmt(e.total) + '€</td><td>' + pagoStr + '</td><td><button class="action-btn" onclick="deleteHistoryItem(\'' + e.id + '\')">Eliminar</button></td></tr>';
      }
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ---------- Export CSV / JSON ----------
    function csvEscape(val){
      if (val === null || val === undefined) return '';
      var s = String(val);
      if (/[,"\n\r]/.test(s)) {
        return '"' + s.replace(/"/g,'""') + '"';
      }
      return s;
    }

    function downloadFile(content, mime, filename){
      var blob = new Blob([content], {type: mime});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function exportHistoryCSV(){
      var history = getHistory();
      if (!history || history.length === 0){ alert('No hay datos para exportar.'); return; }
      var headers = ['id','fechaISO','fechaLegible','itemsText','total','base','iva','pago','cambio'];
      var rows = [];
      for (var i=0;i<history.length;i++){
        var h = history[i];
        rows.push([csvEscape(h.id), csvEscape(h.fechaISO), csvEscape(h.fechaLegible), csvEscape(h.itemsText), csvEscape(h.total), csvEscape(h.base), csvEscape(h.iva), csvEscape(h.pago), csvEscape(h.cambio)].join(','));
      }
      var csv = [headers.join(',')].concat(rows).join('\n');
      downloadFile(csv, 'text/csv;charset=utf-8;', 'lp_tickets_' + (new Date()).toISOString().slice(0,10) + '.csv');
    }

    function downloadHistoryJSON(){
      var history = getHistory();
      if (!history || history.length === 0){ alert('No hay datos para descargar.'); return; }
      var json = JSON.stringify(history, null, 2);
      downloadFile(json, 'application/json;charset=utf-8;', 'lp_tickets_' + (new Date()).toISOString().slice(0,10) + '.json');
    }

    // ---------- Copiar al portapapeles ----------
    function copyToClipboard(txt){
      if (navigator.clipboard && window.isSecureContext){
        return navigator.clipboard.writeText(txt);
      } else {
        var ta = document.createElement('textarea');
        ta.value = txt; document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); } catch(e){ console.warn('copy fallback failed', e); }
        ta.remove(); return Promise.resolve();
      }
    }

    function copyTicketText(){
      if (ticket.length === 0){ alert('No hay productos en el ticket.'); return; }
      var pagoVal = document.getElementById('pagoCliente').value || null;
      var text = generateTicketText(ticket, pagoVal);
      copyToClipboard(text).then(function(){ alert('Ticket copiado al portapapeles.'); });
    }

    // ---------- Print (RawBT/fallback) + save ----------
    function openRawbt(text){
      var encoded = encodeURIComponent(text);
      var candidates = ['rawbt:' + encoded, 'rawbt:=' + encoded, 'rawbt://print?text=' + encoded, 'rawbt://?text=' + encoded];
      // NOTE: window.location.href to a custom protocol will not "throw" if protocol unregistered;
      // browser simply ignores it. We still attempt it.
      try {
        window.location.href = candidates[0];
      } catch(e){ console.warn('rawbt redirect error', e); }
      // Additionally open fallback window with text for copy/paste if needed
      setTimeout(function(){
        var w = window.open('', '_blank');
        if (w){
          w.document.write('<pre style="font-family:monospace;padding:12px;">' + escapeHtmlCompat(text) + '</pre>');
          w.document.title = 'Ticket — copiar/pegar';
        }
      }, 800);
    }

    function onPrintClick(){
      if (ticket.length === 0){ alert('No hay productos seleccionados.'); return; }
      var pagoVal = document.getElementById('pagoCliente').value || null;
      saveTicketToHistory(ticket, pagoVal);
      var text = generateTicketText(ticket, pagoVal);
      openRawbt(text);
      // opcional: reiniciar ticket tras imprimir
      // ticket = []; document.getElementById('pagoCliente').value = ''; updateDisplay();
    }

    // ---------- Cambio ----------
    function calcularCambio(){
      var pagoStr = document.getElementById('pagoCliente').value;
      var pago = parseFloat(pagoStr);
      var total = 0;
      for (var i=0;i<ticket.length;i++) total += ticket[i].price * ticket[i].qty;
      var div = document.getElementById('cambio');
      if (!isNaN(pago)){
        var cambio = pago - total;
        if (cambio < 0){ div.textContent = 'Faltan ' + fmt(Math.abs(cambio)) + '€'; div.style.color='salmon'; }
        else { div.textContent = 'Cambio: ' + fmt(cambio) + '€'; div.style.color='var(--neon-green)'; }
      } else div.textContent = '';
    }

    // ---------- Init: listeners ----------
    document.addEventListener('DOMContentLoaded', function(){
      // attach menu buttons (data-*)
      var buttons = document.querySelectorAll('#menuMain .product-btn');
      for (var i=0;i<buttons.length;i++){
        (function(btn){
          btn.addEventListener('click', function(){
            var name = btn.getAttribute('data-name');
            var price = btn.getAttribute('data-price');
            addProduct(name, price);
          });
        })(buttons[i]);
      }

      // buttons
      document.getElementById('printSaveBtn').addEventListener('click', onPrintClick);
      document.getElementById('copyBtn').addEventListener('click', copyTicketText);
      document.getElementById('clearHistoryBtn').addEventListener('click', clearHistoryConfirm);
      document.getElementById('exportCSVBtn').addEventListener('click', exportHistoryCSV);
      document.getElementById('exportJSONBtn').addEventListener('click', downloadHistoryJSON);
      document.getElementById('pagoCliente').addEventListener('input', calcularCambio);

      // mostrar historial si hay
      updateDisplay();
      renderHistory();

      console.log('TPV inicializado (compatibilidad WebView).');
    });

    // Exponer funciones en global para botones inline (removeProduct) etc.
    window.removeProduct = removeProduct;

  </script>
</body>
</html>
