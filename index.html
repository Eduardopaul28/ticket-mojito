<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tickets La Perla del Caribe & Los Chamos</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f7f7;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    h1 {
      margin: 1rem 0;
    }
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .tab {
      padding: 0.75rem 1.5rem;
      background: #4caf50;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .tab.active {
      background: #388e3c;
      font-weight: bold;
    }
    .section {
      max-width: 400px;
      width: 90vw;
      background: white;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    .button-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }
    button.product-btn {
      padding: 1rem;
      font-size: 1.2rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      user-select: none;
      color: white;
      font-weight: bold;
    }
    button.product-btn.chamos-btn {
      background-color: #2196f3;
    }
    button.product-btn.chamos-btn:active {
      background-color: #1976d2;
    }
    button.product-btn.perla-btn {
      background-color: #4caf50;
    }
    button.product-btn.perla-btn:active {
      background-color: #388e3c;
    }
    #total {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: #333;
      font-weight: bold;
    }
    #ticket-lists {
      font-family: monospace;
      white-space: pre-line;
      text-align: center;
      color: #333;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    button#print, button#reset, button#exportPdf {
      width: 90vw;
      max-width: 400px;
      padding: 1rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 10px;
      margin-bottom: 1rem;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      user-select: none;
    }
    button#print {
      background-color: #2196f3;
      color: white;
    }
    button#print:active {
      background-color: #1976d2;
    }
    button#reset {
      background-color: #f44336;
      color: white;
    }
    button#reset:active {
      background-color: #d32f2f;
    }
    button#exportPdf {
      background-color: #009688;
      color: white;
    }
    button#exportPdf:active {
      background-color: #00796b;
    }
    .remove-item {
      color: red;
      font-weight: bold;
      cursor: pointer;
      margin-left: 8px;
    }
    .tab[data-tab="chamos"] {
      background-color: #2196f3;
      color: white;
    }
    /* Estilos para filtro fechas */
    #filter-section {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 90vw;
      margin-bottom: 1rem;
      text-align: center;
    }
    #filter-section label {
      margin: 0 0.5rem 0 0;
      font-weight: bold;
    }
    #filter-section input {
      padding: 0.25rem 0.5rem;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-right: 1rem;
    }
  </style>
</head>
<body>

  <h1>Tickets La Perla del Caribe & Los Chamos</h1>

  <div class="tabs">
    <div class="tab active" data-tab="chamos">Los Chamos</div>
    <div class="tab" data-tab="perla">La Perla del Caribe</div>
  </div>

  <div id="chamos" class="section tab-content">
    <div class="button-grid">
      <button class="product-btn chamos-btn" onclick="addProduct('Tequeños', 9.99, 'chamos')">Tequeños - 9,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Patatas Locas XL', 11.99, 'chamos')">Patatas Locas XL - 11,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Alitas de pollo BBQ', 14.99, 'chamos')">Alitas BBQ - 14,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Tajadas de plátano', 7.99, 'chamos')">Tajadas - 7,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Pelua', 8.99, 'chamos')">Arepas Pelua - 8,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Sifrina', 8.99, 'chamos')">Arepas Sifrina - 8,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Reina Pepiada', 7.99, 'chamos')">Arepas Reina - 7,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Popular', 7.99, 'chamos')">Arepas Popular - 7,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Los Chamos', 9.99, 'chamos')">Arepas Chamos - 9,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Veguis', 9.99, 'chamos')">Arepas Veguis - 9,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Pabellón', 11.99, 'chamos')">Arepas Pabellón - 11,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Chevere', 11.99, 'chamos')">Arepas Chevere - 11,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Mixta', 11.99, 'chamos')">Arepas Mixta - 11,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Patacón Mortal', 14.99, 'chamos')">Patacón Mortal - 14,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Patacón Los Chamos', 11.99, 'chamos')">Patacón Los Chamos - 11,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Perrito Venezolano', 4.99, 'chamos')">Perrito Venezolano - 4,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Perrito Sencillo', 3.50, 'chamos')">Perrito Sencillo - 3,50€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Perrito Los Chamos', 6.50, 'chamos')">Perrito Los Chamos - 6,50€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Hamburguesa Los Chamos', 11.99, 'chamos')">Hamburguesa - 11,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Malta Maltin/Pony', 2.99, 'chamos')">Malta - 2,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Frescolita', 2.99, 'chamos')">Frescolita - 2,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Suplemento', 1, 'chamos')">Suplemento - 1€</button>
    </div>
  </div>

  <div id="perla" class="section tab-content" style="display:none;">
    <div class="button-grid">
      <button class="product-btn perla-btn" onclick="addProduct('Cóctel Pequeño', 7, 'perla')">Cóctel P - 7€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Cóctel Grande', 12, 'perla')">Cóctel G - 12€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Cóctel sin alcohol Pequeño', 6, 'perla')">Cóctel sn alc P - 6€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Cóctel sin alcohol Grande', 10, 'perla')">Cóctel sn alc G - 10€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Chupito', 3, 'perla')">Chupito - 3€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Cerveza Grande', 6, 'perla')">Cerveza G - 6€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Cerveza', 3, 'perla')">Cerveza - 3€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Refresco', 2.5, 'perla')">Refresco - 2,50€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Zumo', 2.5, 'perla')">Zumo - 2,50€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Agua', 1.5, 'perla')">Agua - 1,50€</button>
    </div>
  </div>

  <!-- Filtro de fechas -->
  <div id="filter-section" class="section">
    <label for="filterStart">Fecha inicio:</label>
    <input type="date" id="filterStart" />
    <label for="filterEnd">Fecha fin:</label>
    <input type="date" id="filterEnd" />
    <button onclick="filterTicketsByDate()">Filtrar tickets</button>
  </div>

  <div id="total" style="font-size: 2rem;"></div>

  <div id="ticket-lists"></div>

  <button id="print" onclick="printTickets()">Imprimir tickets</button>
  <button id="reset" onclick="resetTickets()">Borrar tickets</button>
  <button id="exportPdf" onclick="exportTicketsToPdf()">Exportar a PDF</button>

  <script>
    // Tus arrays originales
    const ticketLosChamos = [];
    const ticketPerla = [];

    // Para almacenar la fecha de cada producto añadido
    const ticketLosChamosFull = [];
    const ticketPerlaFull = [];

    // Función para cambiar pestañas (tu código intacto)
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', e => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        document.getElementById(e.target.dataset.tab).style.display = 'block';
      });
    });

    // Añadir producto (tu código intacto + guardamos fecha)
    function addProduct(name, price, tipo) {
      const fechaAhora = new Date();

      if(tipo === 'chamos') {
        ticketLosChamos.push({ name, price });
        ticketLosChamosFull.push({ name, price, date: fechaAhora });
      } else {
        ticketPerla.push({ name, price });
        ticketPerlaFull.push({ name, price, date: fechaAhora });
      }
      updateDisplay();
    }

    // Actualizar display, sin tocar tu código original excepto para incluir botón borrar individual (añadido)
    function updateDisplay() {
      let displayText = '';
      let total = 0;

      if(ticketLosChamos.length > 0) {
        displayText += 'Los Chamos:\n';
        ticketLosChamos.forEach((p, i) => {
          displayText += `${p.name} - ${p.price.toFixed(2)}€` + ` <span class="remove-item" onclick="removeProduct('chamos', ${i})">[x]</span>\n`;
          total += p.price;
        });
        displayText += `Total Los Chamos: ${total.toFixed(2)}€\n\n`;
      }

      let totalPerla = 0;
      if(ticketPerla.length > 0) {
        displayText += 'La Perla del Caribe:\n';
        ticketPerla.forEach((p, i) => {
          displayText += `${p.name} - ${p.price.toFixed(2)}€` + ` <span class="remove-item" onclick="removeProduct('perla', ${i})">[x]</span>\n`;
          totalPerla += p.price;
        });
        displayText += `Total La Perla: ${totalPerla.toFixed(2)}€\n\n`;
      }

      total += totalPerla;

      document.getElementById('ticket-lists').innerHTML = displayText.replace(/\n/g, '<br>');
      document.getElementById('total').textContent = `Total acumulado: ${total.toFixed(2)}€`;
    }

    // Remover producto individual, agregando fecha también a arrays completos
    function removeProduct(tipo, index) {
      if(tipo === 'chamos') {
        ticketLosChamos.splice(index, 1);
        ticketLosChamosFull.splice(index, 1);
      } else {
        ticketPerla.splice(index, 1);
        ticketPerlaFull.splice(index, 1);
      }
      updateDisplay();
    }

    // Borrar todo el ticket
    function resetTickets() {
      ticketLosChamos.length = 0;
      ticketPerla.length = 0;
      ticketLosChamosFull.length = 0;
      ticketPerlaFull.length = 0;
      updateDisplay();
    }

    // Función para generar texto del ticket (tu función original intacta)
    function generateTicketText(products, businessName, total) {
      let text = `${businessName}\n----------------\n`;
      products.forEach(p => {
        text += `${p.name} - ${p.price.toFixed(2)}€\n`;
      });
      text += `----------------\nTotal: ${total.toFixed(2)}€`;
      return text;
    }

    // Función impresión (tu función intacta, llamando openRawbt)
    function openRawbt(text) {
      const url = 'rawbt://print?text=' + encodeURIComponent(text);
      window.location.href = url;
    }

    // Función impresión tickets, sin modificar tu lógica, pero evitando llamadas dobles
    function printTickets() {
      if(ticketLosChamos.length === 0 && ticketPerla.length === 0) {
        return alert('No hay productos seleccionados.');
      }

      const totalChamos = ticketLosChamos.reduce((acc, p) => acc + p.price, 0);
      const totalPerla = ticketPerla.reduce((acc, p) => acc + p.price, 0);

      let finalText = '';

      if(ticketLosChamos.length) {
        finalText += generateTicketText(ticketLosChamos, 'Los Chamos', totalChamos) + '\n\n';
      }

      if(ticketPerla.length) {
        finalText += generateTicketText(ticketPerla, 'La Perla del Caribe', totalPerla);
      }

      openRawbt(finalText.trim());
    }

    // Nueva función para filtrar tickets por fecha
    function filterTicketsByDate() {
      const startDateInput = document.getElementById('filterStart').value;
      const endDateInput = document.getElementById('filterEnd').value;

      if(!startDateInput || !endDateInput) {
        alert('Por favor, selecciona ambas fechas para filtrar.');
        return;
      }

      const startDate = new Date(startDateInput);
      const endDate = new Date(endDateInput);
      // Aseguramos que endDate incluya todo el día
      endDate.setHours(23,59,59,999);

      // Filtrar arrays con fechas dentro del rango
      const filteredChamos = ticketLosChamosFull.filter(p => {
        const d = new Date(p.date);
        return d >= startDate && d <= endDate;
      });

      const filteredPerla = ticketPerlaFull.filter(p => {
        const d = new Date(p.date);
        return d >= startDate && d <= endDate;
      });

      // Mostrar en pantalla los tickets filtrados (simplemente)
      let displayText = '';
      let total = 0;

      if(filteredChamos.length > 0) {
        displayText += 'Los Chamos (Filtrado):\n';
        filteredChamos.forEach(p => {
          displayText += `${p.name} - ${p.price.toFixed(2)}€\n`;
          total += p.price;
        });
        displayText += `Total Los Chamos: ${total.toFixed(2)}€\n\n`;
      }

      let totalPerla = 0;
      if(filteredPerla.length > 0) {
        displayText += 'La Perla del Caribe (Filtrado):\n';
        filteredPerla.forEach(p => {
          displayText += `${p.name} - ${p.price.toFixed(2)}€\n`;
          totalPerla += p.price;
        });
        displayText += `Total La Perla: ${totalPerla.toFixed(2)}€\n\n`;
      }

      total += totalPerla;

      if(displayText === '') {
        displayText = 'No hay productos en ese rango de fechas.';
      }

      document.getElementById('ticket-lists').innerHTML = displayText.replace(/\n/g, '<br>');
      document.getElementById('total').textContent = `Total acumulado (filtrado): ${total.toFixed(2)}€`;
    }

    // Función para exportar a PDF usando jsPDF
    async function exportTicketsToPdf() {
      // Cargamos jsPDF desde CDN (solo la primera vez)
      if (!window.jsPDF) {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let y = 10;
      doc.setFontSize(16);
      doc.text('Tickets La Perla del Caribe & Los Chamos', 10, y);
      y += 10;

      function writeProducts(title, products) {
        doc.setFontSize(14);
        doc.text(title, 10, y);
        y += 8;
        doc.setFontSize(12);
        products.forEach(p => {
          doc.text(`${p.name} - ${p.price.toFixed(2)}€`, 10, y);
          y += 7;
          if (y > 280) { doc.addPage(); y = 10; }
        });
        const total = products.reduce((acc, p) => acc + p.price, 0);
        doc.setFontSize(13);
        doc.text(`Total: ${total.toFixed(2)}€`, 10, y);
        y += 10;
      }

      if(ticketLosChamos.length) {
        writeProducts('Los Chamos:', ticketLosChamos);
      }

      if(ticketPerla.length) {
        writeProducts('La Perla del Caribe:', ticketPerla);
      }

      if(ticketLosChamos.length === 0 && ticketPerla.length === 0) {
        doc.setFontSize(12);
        doc.text('No hay productos seleccionados.', 10, y);
      }

      doc.save('tickets.pdf');
    }

    // Helper para cargar scripts externos
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    updateDisplay(); // Mostrar estado inicial
  </script>
</body>
</html>
