<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tickets La Perla del Caribe & Los Chamos</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f7f7;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    h1 {
      margin: 1rem 0;
    }
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .tab {
      padding: 0.75rem 1.5rem;
      background: #4caf50;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      font-weight: bold;
    }
    .tab.active {
      background: #388e3c;
    }
    .tab[data-tab="chamos"] {
      background-color: #2196f3;
    }
    .tab[data-tab="chamos"].active {
      background-color: #1976d2;
    }
    .section {
      max-width: 400px;
      width: 90vw;
      background: white;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    .button-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }
    button.product-btn {
      padding: 1rem;
      font-size: 1.2rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      user-select: none;
      color: white;
      font-weight: bold;
    }
    button.product-btn.chamos-btn {
      background-color: #2196f3;
    }
    button.product-btn.chamos-btn:active {
      background-color: #1976d2;
    }
    button.product-btn.perla-btn {
      background-color: #4caf50;
    }
    button.product-btn.perla-btn:active {
      background-color: #388e3c;
    }
    #total {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: #333;
      font-weight: bold;
    }
    #ticket-lists {
      font-family: monospace;
      white-space: pre-line;
      text-align: center;
      color: #333;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    button#print, button#reset, button#open-history {
      width: 90vw;
      max-width: 400px;
      padding: 1rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 10px;
      margin-bottom: 1rem;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      user-select: none;
      font-weight: bold;
    }
    button#print {
      background-color: #2196f3;
      color: white;
    }
    button#print:active {
      background-color: #1976d2;
    }
    button#reset {
      background-color: #f44336;
      color: white;
    }
    button#reset:active {
      background-color: #d32f2f;
    }
    /* Modal styles */
    #historyModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      overflow: auto;
    }
    #historyContent {
      background: white;
      margin: 5% auto;
      padding: 1rem;
      border-radius: 10px;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      position: relative;
    }
    #closeHistory {
      position: absolute;
      right: 1rem;
      top: 1rem;
      font-size: 1.5rem;
      cursor: pointer;
      font-weight: bold;
      border: none;
      background: none;
      color: #f44336;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
      font-size: 0.9rem;
    }
    th {
      background-color: #4caf50;
      color: white;
      font-weight: bold;
    }
    td.remove-ticket {
      color: red;
      cursor: pointer;
      font-weight: bold;
    }
    #filterControls {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    #filterControls input, #filterControls button {
      flex: 1;
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      min-width: 120px;
    }
    #filterControls button {
      background-color: #2196f3;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: background-color 0.3s;
    }
    #filterControls button:hover {
      background-color: #1976d2;
    }
    #totalsHistory {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 0.5rem;
      color: #333;
      text-align: right;
    }
  </style>
</head>
<body>

  <h1>Tickets La Perla del Caribe & Los Chamos</h1>

  <div class="tabs">
    <div class="tab active" data-tab="chamos">Los Chamos</div>
    <div class="tab" data-tab="perla">La Perla del Caribe</div>
  </div>

  <div id="chamos" class="section tab-content">
    <div class="button-grid">
      <button class="product-btn chamos-btn" onclick="addProduct('Tequeños', 9.99, 'chamos')">Tequeños - 9,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Patatas Locas XL', 11.99, 'chamos')">Patatas Locas XL - 11,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Alitas de pollo BBQ', 14.99, 'chamos')">Alitas BBQ - 14,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Tajadas de plátano', 7.99, 'chamos')">Tajadas - 7,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Pelua', 8.99, 'chamos')">Arepas Pelua - 8,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Sifrina', 8.99, 'chamos')">Arepas Sifrina - 8,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Reina Pepiada', 7.99, 'chamos')">Arepas Reina - 7,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Popular', 7.99, 'chamos')">Arepas Popular - 7,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Los Chamos', 9.99, 'chamos')">Arepas Chamos - 9,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Veguis', 9.99, 'chamos')">Arepas Veguis - 9,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Pabellón', 11.99, 'chamos')">Arepas Pabellón - 11,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Chevere', 11.99, 'chamos')">Arepas Chevere - 11,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Arepa Mixta', 11.99, 'chamos')">Arepas Mixta - 11,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Patacón Mortal', 14.99, 'chamos')">Patacón Mortal - 14,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Patacón Los Chamos', 11.99, 'chamos')">Patacón Los Chamos - 11,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Perrito Venezolano', 4.99, 'chamos')">Perrito Venezolano - 4,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Perrito Sencillo', 3.50, 'chamos')">Perrito Sencillo - 3,50€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Perrito Los Chamos', 6.50, 'chamos')">Perrito Los Chamos - 6,50€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Hamburguesa Los Chamos', 10.99, 'chamos')">Hamburguesa Chamos - 10,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Hamburguesa Mortadela', 14.99, 'chamos')">Hamburguesa Mortadela - 14,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Hamburguesa Chevere', 14.99, 'chamos')">Hamburguesa Chevere - 14,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Perro Chevere', 10.99, 'chamos')">Perro Chevere - 10,99€</button>
      <button class="product-btn chamos-btn" onclick="addProduct('Papas Los Chamos', 5.99, 'chamos')">Papas Los Chamos - 5,99€</button>
    </div>
  </div>

  <div id="perla" class="section tab-content" style="display:none;">
    <div class="button-grid">
      <button class="product-btn perla-btn" onclick="addProduct('Cuba Libre', 6.99, 'perla')">Cuba Libre - 6,99€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Mojito', 7.99, 'perla')">Mojito - 7,99€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Piña Colada', 7.99, 'perla')">Piña Colada - 7,99€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Ron Blanco', 5.99, 'perla')">Ron Blanco - 5,99€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Ron Añejo', 6.99, 'perla')">Ron Añejo - 6,99€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Vodka', 6.50, 'perla')">Vodka - 6,50€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Tequila', 6.99, 'perla')">Tequila - 6,99€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Cerveza', 4.99, 'perla')">Cerveza - 4,99€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Agua', 2.50, 'perla')">Agua - 2,50€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Refresco', 3.00, 'perla')">Refresco - 3,00€</button>
      <button class="product-btn perla-btn" onclick="addProduct('Jugo Natural', 4.00, 'perla')">Jugo Natural - 4,00€</button>
    </div>
  </div>

  <div class="section" style="max-width: 400px; width: 90vw;">
    <div id="ticket-lists">
      <strong>Los Chamos:</strong><br>
      <span id="list-chamos"></span>
      <hr />
      <strong>La Perla del Caribe:</strong><br>
      <span id="list-perla"></span>
    </div>
    <div id="total">Total: 0,00€</div>
  </div>

  <button id="print">Imprimir Ticket</button>
  <button id="reset">Reiniciar Ticket</button>
  <button id="open-history">Historial de Tickets</button>

  <!-- Modal Historial -->
  <div id="historyModal">
    <div id="historyContent">
      <button id="closeHistory">&times;</button>
      <h2>Historial de Tickets</h2>
      <div id="filterControls">
        <input type="date" id="filterStart" />
        <input type="date" id="filterEnd" />
        <button id="filterBtn">Filtrar</button>
        <button id="clearFilterBtn" style="background:#f44336;">Limpiar filtro</button>
        <button id="clearHistoryBtn" style="background:#f44336;">Borrar todo historial</button>
        <button id="exportPdfBtn" style="background:#2196f3;">Exportar a PDF</button>
      </div>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Fecha / Hora</th>
            <th>Negocio</th>
            <th>Detalles</th>
            <th>Total (€)</th>
            <th>Eliminar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="totalsHistory"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Variables para tickets actuales
    let ticketChamos = [];
    let ticketPerla = [];

    // Función para actualizar la lista y total visual
    function updateDisplay() {
      // Mostrar productos en cada lista
      const listChamos = document.getElementById('list-chamos');
      const listPerla = document.getElementById('list-perla');

      listChamos.innerHTML = ticketChamos.map((p, i) => 
        `${p.name} (${p.price.toFixed(2)}€) <button onclick="removeProduct('chamos', ${i})" style="color:red; font-weight:bold;">❌</button>`
      ).join('<br>') || '(vacío)';

      listPerla.innerHTML = ticketPerla.map((p, i) => 
        `${p.name} (${p.price.toFixed(2)}€) <button onclick="removeProduct('perla', ${i})" style="color:red; font-weight:bold;">❌</button>`
      ).join('<br>') || '(vacío)';

      // Calcular totales
      const totalChamos = ticketChamos.reduce((sum, p) => sum + p.price, 0);
      const totalPerla = ticketPerla.reduce((sum, p) => sum + p.price, 0);
      const total = totalChamos + totalPerla;

      document.getElementById('total').textContent = `Total: ${total.toFixed(2).replace('.', ',')}€`;
    }

    // Añadir producto al ticket
    function addProduct(name, price, negocio) {
      if (negocio === 'chamos') ticketChamos.push({name, price});
      else if (negocio === 'perla') ticketPerla.push({name, price});
      updateDisplay();
    }

    // Remover producto del ticket
    function removeProduct(negocio, index) {
      if (negocio === 'chamos') ticketChamos.splice(index, 1);
      else if (negocio === 'perla') ticketPerla.splice(index, 1);
      updateDisplay();
    }

    // Reiniciar ticket actual
    document.getElementById('reset').addEventListener('click', () => {
      if(confirm('¿Quieres reiniciar el ticket actual? Se perderán los productos seleccionados.')){
        ticketChamos = [];
        ticketPerla = [];
        updateDisplay();
      }
    });

    // Pestañas para cambiar entre negocios
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        document.getElementById(tab.dataset.tab).style.display = 'block';
      });
    });

    // Guardar ticket en historial
    function saveTicket() {
      const now = new Date();
      const fecha = now.toISOString();
      const totalChamos = ticketChamos.reduce((sum, p) => sum + p.price, 0);
      const totalPerla = ticketPerla.reduce((sum, p) => sum + p.price, 0);

      const newTickets = [];

      if(ticketChamos.length > 0){
        newTickets.push({
          id: crypto.randomUUID(),
          date: fecha,
          negocio: 'Los Chamos',
          items: [...ticketChamos],
          total: totalChamos
        });
      }
      if(ticketPerla.length > 0){
        newTickets.push({
          id: crypto.randomUUID(),
          date: fecha,
          negocio: 'La Perla del Caribe',
          items: [...ticketPerla],
          total: totalPerla
        });
      }

      if(newTickets.length === 0) {
        alert('No hay productos para guardar.');
        return false;
      }

      // Cargar historial previo y añadir nuevo(s)
      let historial = JSON.parse(localStorage.getItem('ticketHistorial') || '[]');
      historial = historial.concat(newTickets);
      localStorage.setItem('ticketHistorial', JSON.stringify(historial));
      return newTickets;
    }

    // Imprimir ticket (simulado con ventana nueva)
    document.getElementById('print').addEventListener('click', () => {
      const ticketsGuardados = saveTicket();
      if(!ticketsGuardados) return;

      ticketsGuardados.forEach(t => {
        const printWindow = window.open('', '_blank', 'width=300,height=600');
        printWindow.document.write('<pre style="font-family: monospace; font-size:16px;">');
        printWindow.document.write('*** TICKET ***\n');
        printWindow.document.write(`Fecha: ${new Date(t.date).toLocaleString()}\n`);
        printWindow.document.write(`Negocio: ${t.negocio}\n\n`);
        t.items.forEach(i => {
          printWindow.document.write(`${i.name.padEnd(25, ' ')} ${i.price.toFixed(2).replace('.', ',')}€\n`);
        });
        printWindow.document.write('\n');
        printWindow.document.write(`TOTAL: ${t.total.toFixed(2).replace('.', ',')}€\n`);
        printWindow.document.write('Gracias por su compra!\n');
        printWindow.document.write('****************\n');
        printWindow.document.write('</pre>');
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
      });

      // Reiniciar tickets luego de impresión
      ticketChamos = [];
      ticketPerla = [];
      updateDisplay();
    });

    // Mostrar historial en modal
    const modal = document.getElementById('historyModal');
    const tbody = document.querySelector('#historyTable tbody');
    const totalsHistoryDiv = document.getElementById('totalsHistory');

    document.getElementById('open-history').addEventListener('click', () => {
      modal.style.display = 'block';
      loadHistory();
    });

    document.getElementById('closeHistory').addEventListener('click', () => {
      modal.style.display = 'none';
    });

    // Cargar historial desde localStorage y mostrar en tabla
    function loadHistory(filterStart=null, filterEnd=null) {
      let historial = JSON.parse(localStorage.getItem('ticketHistorial') || '[]');

      // Filtrar por fecha si aplica
      if(filterStart) {
        historial = historial.filter(t => new Date(t.date) >= filterStart);
      }
      if(filterEnd) {
        historial = historial.filter(t => new Date(t.date) <= filterEnd);
      }

      // Limpiar tabla
      tbody.innerHTML = '';

      let totalChamos = 0;
      let totalPerla = 0;

      if(historial.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No hay tickets.</td></tr>';
      } else {
        historial.forEach(ticket => {
          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>${new Date(ticket.date).toLocaleString()}</td>
            <td>${ticket.negocio}</td>
            <td style="text-align:left; white-space: pre-wrap;">${ticket.items.map(i => `${i.name} (${i.price.toFixed(2).replace('.', ',')}€)`).join('\n')}</td>
            <td>${ticket.total.toFixed(2).replace('.', ',')}€</td>
            <td class="remove-ticket" data-id="${ticket.id}">❌</td>
          `;
          tbody.appendChild(tr);

          if(ticket.negocio === 'Los Chamos') totalChamos += ticket.total;
          else if(ticket.negocio === 'La Perla del Caribe') totalPerla += ticket.total;
        });
      }
      totalsHistoryDiv.textContent = `Total Los Chamos: ${totalChamos.toFixed(2).replace('.', ',')}€ | Total La Perla: ${totalPerla.toFixed(2).replace('.', ',')}€ | Total General: ${(totalChamos+totalPerla).toFixed(2).replace('.', ',')}€`;

      // Añadir evento borrar ticket
      document.querySelectorAll('.remove-ticket').forEach(btn => {
        btn.onclick = () => {
          if(confirm('¿Eliminar este ticket del historial?')){
            deleteTicket(btn.dataset.id);
          }
        }
      });
    }

    // Borrar ticket individual del historial
    function deleteTicket(id) {
      let historial = JSON.parse(localStorage.getItem('ticketHistorial') || '[]');
      historial = historial.filter(t => t.id !== id);
      localStorage.setItem('ticketHistorial', JSON.stringify(historial));
      loadHistory(
        document.getElementById('filterStart').value ? new Date(document.getElementById('filterStart').value) : null,
        document.getElementById('filterEnd').value ? new Date(document.getElementById('filterEnd').value) : null
      );
    }

    // Botones de filtro
    document.getElementById('filterBtn').addEventListener('click', () => {
      const startDate = document.getElementById('filterStart').value ? new Date(document.getElementById('filterStart').value) : null;
      const endDate = document.getElementById('filterEnd').value ? new Date(document.getElementById('filterEnd').value) : null;
      loadHistory(startDate, endDate);
    });

    document.getElementById('clearFilterBtn').addEventListener('click', () => {
      document.getElementById('filterStart').value = '';
      document.getElementById('filterEnd').value = '';
      loadHistory();
    });

    // Borrar todo historial
    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
      if(confirm('¿Estás seguro de borrar TODO el historial? Esta acción no se puede deshacer.')){
        localStorage.removeItem('ticketHistorial');
        loadHistory();
      }
    });

    // Exportar historial visible a PDF
    document.getElementById('exportPdfBtn').addEventListener('click', () => {
      import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js').then(jsPDFModule => {
        const { jsPDF } = jsPDFModule;
        const doc = new jsPDF();

        const rows = [];
        const headers = [["Fecha / Hora", "Negocio", "Detalles", "Total (€)"]];

        const rowsData = Array.from(tbody.querySelectorAll('tr')).map(tr => {
          const cells = Array.from(tr.children);
          if(cells.length === 5) {
            return [
              cells[0].textContent,
              cells[1].textContent,
              cells[2].textContent,
              cells[3].textContent
            ];
          }
          return null;
        }).filter(r => r !== null);

        doc.setFontSize(14);
        doc.text("Historial de Tickets", 14, 20);

        // Formatear detalles con saltos de línea en PDF es más complejo, así que lo ponemos plano.
        doc.setFontSize(10);
        let y = 30;

        rowsData.forEach(row => {
          let text = `${row[0]} | ${row[1]} | ${row[2].replace(/\n/g, ', ')} | ${row[3]}`;
          doc.text(text, 14, y);
          y += 8;
          if(y > 280) {
            doc.addPage();
            y = 20;
          }
        });

        // Añadir totales abajo
        const totalsText = totalsHistoryDiv.textContent;
        doc.setFontSize(12);
        if(y > 270) doc.addPage();
        doc.text(totalsText, 14, y + 10);

        doc.save(`historial_tickets_${new Date().toISOString().slice(0,10)}.pdf`);
      });
    });

    // Inicializar la pantalla
    updateDisplay();
  </script>

</body>
</html>
