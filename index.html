<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La Perla del Caribe - TPV</title>
  <style>
    :root{
      --bg-1: #05020a;
      --neon-pink: #ff2fa6;
      --neon-cyan: #1fe6ff;
      --neon-orange: #ff9f1c;
      --neon-green: #23ff88;
      --muted: #cbd5e1;
    }
    html,body{height:100%;margin:0;background:radial-gradient(ellipse at 10% 10%, rgba(31,230,255,0.06), transparent 10%), radial-gradient(ellipse at 90% 80%, rgba(255,47,166,0.04), transparent 10%), linear-gradient(180deg,#02030a 0%, #07060b 100%);font-family:"Segoe UI", Roboto, Arial, sans-serif;color:#f6f7fb;display:flex;justify-content:center;padding:1rem;}
    .app{width:100%;max-width:980px;}
    header.app-header{display:flex;align-items:center;gap:1rem;margin-bottom:0.6rem;}
    .logo{width:70px;height:70px;border-radius:12px;background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(255,255,255,0.04);}
    .logo img{width:100%;height:100%;object-fit:cover;}
    h1{margin:0;font-size:1.15rem;}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:1rem;align-items:start;}
    .panel{background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);}
    .button-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem;}
    .product-btn{padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;font-size:0.98rem;color:#06060b;box-shadow:0 6px 18px rgba(0,0,0,0.45);}
    .btn-neon-green{background:linear-gradient(180deg,#23ff88,#0fe66d);} .btn-neon-cyan{background:linear-gradient(180deg,#1fe6ff,#00c8e6);} .btn-neon-orange{background:linear-gradient(180deg,#ff9f1c,#ff7a1f);} .btn-neon-pink{background:linear-gradient(180deg,#ff2fa6,#ff1f8f);}
    .ticket{border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.03);}
    #ticket-lists{font-family:monospace;white-space:pre-wrap;color:#e6eef6;margin-bottom:8px;min-height:110px;font-size:0.98rem;}
    #total{font-size:0.95rem;font-weight:700;color:var(--neon-green);margin-bottom:8px;}
    .controls .row{display:flex;gap:8px;}
    .big-btn{padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;}
    #print{background:linear-gradient(180deg,var(--neon-cyan),#00a9d6);color:#001216;}
    #copy{background:linear-gradient(180deg,var(--neon-pink),#ff1f8f);color:#100;}
    #export{background:linear-gradient(180deg,var(--neon-green),#0fbf6d);color:#051;}
    .small{font-size:0.85rem;color:var(--muted);}
    /* Historial styles */
    .history { margin-top:12px; max-height:300px; overflow:auto; background: rgba(255,255,255,0.02); padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); }
    table.history-table{width:100%;border-collapse:collapse;font-size:0.9rem;}
    table.history-table th, table.history-table td{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03); text-align:left; vertical-align:top;}
    .muted{color:var(--muted); font-size:0.85rem;}
    .action-btn{padding:6px 8px;border-radius:6px;border:none;cursor:pointer;font-weight:700;}
    .del{background:transparent;color:#ff7a9a;}
    .clear{background:transparent;color:#ffb86b;}
    @media(max-width:920px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="logo"><img src="src.jpg" alt="logo" /></div>
      <div><h1>La Perla del Caribe — TPV</h1><div class="muted">Guarda tickets localmente y exporta a Excel</div></div>
    </header>

    <main class="grid">
      <!-- Menu -->
      <div class="panel">
        <div style="margin-bottom:8px;"><strong>Menú</strong></div>
        <div class="button-grid" id="menuMain">
          <button class="product-btn btn-neon-green" onclick="addProduct('Copa normal', 8.00)">Copa normal - 8,00€</button>
          <button class="product-btn btn-neon-green" onclick="addProduct('Copa premium', 10.00)">Copa premium - 10,00€</button>
          <button class="product-btn btn-neon-green" onclick="addProduct('Redbull +1', 1.00)">Redbull +1 - 1,00€</button>
          <button class="product-btn btn-neon-green" onclick="addProduct('Cóctel', 8.00)">Cóctel - 8,00€</button>
          <button class="product-btn btn-neon-cyan" onclick="addProduct('Cerveza tercio normal', 3.50)">Tercio normal - 3,50€</button>
          <button class="product-btn btn-neon-cyan" onclick="addProduct('Caña normal', 3.00)">Caña normal - 3,00€</button>
          <button class="product-btn btn-neon-orange" onclick="addProduct('Refresco', 3.00)">Refresco - 3,00€</button>
          <button class="product-btn btn-neon-pink" onclick="addProduct('Chupito', 3.00)">Chupito - 3,00€</button>
          <button class="product-btn btn-neon-pink" onclick="addProduct('Cubo', 15.00)">Cubo - 15,00€</button>
        </div>
        <br>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <div style="flex:1;min-width:140px;">
            <label class="small">Pago cliente (€)</label>
            <input type="number" id="pagoCliente" placeholder="50,00" oninput="calcularCambio()" step="0.01" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:#eaf6ff;">
          </div>
        </div>

        <div class="history">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <strong>Historial de tickets</strong>
            <div>
              <button class="action-btn clear" onclick="clearHistoryConfirm()">Limpiar historial</button>
              <button class="action-btn" onclick="exportHistoryCSV()">Exportar CSV</button>
              <button class="action-btn" onclick="downloadHistoryJSON()">Descargar JSON</button>
            </div>
          </div>
          <div id="historyContainer">
            <!-- tabla se renderiza por JS -->
          </div>
        </div>
      </div>

      <!-- Ticket -->
      <aside class="ticket panel">
        <h2>Ticket</h2>
        <div id="ticket-lists">(aún no hay productos)</div>
        <div id="total">Total: 0,00€</div>
        <div id="cambio" class="small" style="margin-bottom:8px;color:var(--neon-green);font-weight:700;"></div>

        <div class="controls">
          <div class="row" style="margin-bottom:8px;">
            <button id="print" class="big-btn" onclick="onPrintClick()">Imprimir & Guardar</button>
            <button id="copy" class="big-btn" onclick="copyTicketText()">Copiar</button>
          </div>
        </div>

        <div class="muted" style="margin-top:8px;font-size:0.85rem;">
          Cada vez que pulses <strong>Imprimir & Guardar</strong> el ticket se almacenará en el historial (almacenamiento local del navegador).
        </div>
      </aside>
    </main>
  </div>

  <script>
    /* -----------------------------------------
       Configuración y utilidades
       ----------------------------------------- */
    const IVA_RATE = 0.21;                      // modificar si tu IVA es distinto
    const HISTORY_KEY = 'lp_ticket_history_v1'; // clave localStorage (versionable)

    let ticket = [];

    function fmt(eur){
      const n = Number(eur) || 0;
      return n.toLocaleString('es-ES', {minimumFractionDigits:2, maximumFractionDigits:2});
    }

    /* -----------------------------------------
       Ticket: añadir/quitar/visualizar
       ----------------------------------------- */
    function addProduct(name, price){
      price = parseFloat(price) || 0;
      const existing = ticket.find(p => p.name === name);
      if (existing) existing.qty++;
      else ticket.push({name, price, qty:1});
      updateDisplay();
      calcularCambio();
    }

    function removeProduct(name){
      const idx = ticket.findIndex(p => p.name === name);
      if (idx === -1) return;
      if (ticket[idx].qty > 1) ticket[idx].qty--;
      else ticket.splice(idx,1);
      updateDisplay();
      calcularCambio();
    }

    function updateDisplay(){
      const total = ticket.reduce((s,p)=> s + p.price * p.qty, 0);
      const base = total / (1 + IVA_RATE);
      const iva = total - base;

      if (ticket.length === 0){
        document.getElementById('ticket-lists').textContent = '(aún no hay productos)';
      } else {
        let html = '';
        ticket.forEach(p => {
          html += `<span style="font-family:monospace;">${p.name} x${p.qty} - ${fmt(p.price * p.qty)}€</span> <button class="action-btn del" onclick="removeProduct('${p.name.replace(/'/g,\"\\'\")}')">❌</button><br>`;
        });
        document.getElementById('ticket-lists').innerHTML = html;
      }

      document.getElementById('total').innerHTML = `Base imponible: ${fmt(base)}€<br>IVA (${Math.round(IVA_RATE*100)}%): ${fmt(iva)}€<br><strong>Total: ${fmt(total)}€</strong>`;
    }

    /* -----------------------------------------
       Generación texto ticket (para imprimir y guardar)
       ----------------------------------------- */
    function generateTicketText(items, pagoClienteVal = null, vatRate = IVA_RATE){
      const ahora = new Date();
      const fecha = ahora.toLocaleString('es-ES');
      const total = items.reduce((s,p)=> s + p.price * p.qty, 0);
      const base = total / (1 + vatRate);
      const iva = total - base;

      let lines = [];
      lines.push('*** La Perla del Caribe ***');
      lines.push(`Fecha: ${fecha}`);
      lines.push('');
      lines.push('Productos:');
      lines.push('-----------------------------');
      items.forEach(p => {
        const subtotal = p.price * p.qty;
        lines.push(`${p.name} x${p.qty}  ${fmt(subtotal)}€`);
      });
      lines.push('-----------------------------');
      lines.push(`Base imponible: ${fmt(base)}€`);
      lines.push(`IVA (${Math.round(vatRate*100)}%): ${fmt(iva)}€`);
      lines.push(`TOTAL: ${fmt(total)}€`);
      if (pagoClienteVal !== null && pagoClienteVal !== ''){
        const pago = parseFloat(pagoClienteVal) || 0;
        const cambio = pago - total;
        lines.push(`Pago: ${fmt(pago)}€`);
        lines.push(`Cambio: ${fmt(cambio)}€`);
      }
      lines.push('');
      lines.push('Gracias por su visita!');
      return lines.join('\n');
    }

    /* -----------------------------------------
       Historial en localStorage
       Estructura de cada entrada:
       { id, fechaISO, fechaLegible, items: [{name,price,qty}], itemsText, total, base, iva, pago, cambio }
       ----------------------------------------- */
    function getHistory(){
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch(e){
        console.warn('Error leyendo historial', e);
        return [];
      }
    }

    function saveHistory(history){
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function saveTicketToHistory(items, pagoClienteVal = null){
      const now = new Date();
      const id = `${now.getTime()}`; // timestamp único
      const total = items.reduce((s,p)=> s + p.price * p.qty, 0);
      const base = total / (1 + IVA_RATE);
      const iva = total - base;
      const pago = (pagoClienteVal !== null && pagoClienteVal !== '') ? parseFloat(pagoClienteVal) : null;
      const cambio = (pago !== null) ? (pago - total) : null;

      // itemsText — formato compacto para CSV/tabla
      const itemsText = items.map(p => `${p.name} x${p.qty} (${fmt(p.price)}u)`).join(' ; ');

      const entry = {
        id,
        fechaISO: now.toISOString(),
        fechaLegible: now.toLocaleString('es-ES'),
        items: items.map(p => ({name: p.name, price: p.price, qty: p.qty})),
        itemsText,
        total: Number(total.toFixed(2)),
        base: Number(base.toFixed(2)),
        iva: Number(iva.toFixed(2)),
        pago: pago !== null ? Number(pago.toFixed(2)) : null,
        cambio: cambio !== null ? Number(cambio.toFixed(2)) : null
      };

      const history = getHistory();
      history.unshift(entry); // añadimos al principio
      // opcional: limitar tamaño (ej. últimos 200 tickets)
      const MAX = 1000;
      if (history.length > MAX) history.splice(MAX);
      saveHistory(history);
      renderHistory();
      return entry;
    }

    function deleteHistoryItem(id){
      let history = getHistory();
      history = history.filter(h => h.id !== id);
      saveHistory(history);
      renderHistory();
    }

    function clearHistoryConfirm(){
      if (!confirm('¿Borrar todo el historial de tickets? Esta acción no se puede deshacer.')) return;
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
    }

    /* -----------------------------------------
       Render historial en la UI
       ----------------------------------------- */
    function renderHistory(){
      const container = document.getElementById('historyContainer');
      const history = getHistory();
      if (!history.length){
        container.innerHTML = '<div class="muted">No hay tickets guardados.</div>';
        return;
      }

      let html = `<table class="history-table"><thead><tr><th>Fecha</th><th>Items</th><th>Total</th><th>Pago</th><th></th></tr></thead><tbody>`;
      history.forEach(entry => {
        html += `<tr>
          <td style="white-space:nowrap;">${escapeHtml(entry.fechaLegible)}</td>
          <td>${escapeHtml(entry.itemsText)}</td>
          <td>${fmt(entry.total)}€</td>
          <td>${entry.pago !== null ? fmt(entry.pago)+'€ ('+ (entry.cambio!==null?('cambio '+fmt(entry.cambio)+'€'):'') +')' : '-'}</td>
          <td><button class="action-btn del" onclick="deleteHistoryItem('${entry.id}')">Eliminar</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    /* -----------------------------------------
       Exportar CSV / JSON
       ----------------------------------------- */
    function exportHistoryCSV(){
      const history = getHistory();
      if (!history.length){ alert('No hay datos para exportar.'); return; }

      // Cabeceras CSV
      const headers = ['id','fechaISO','fechaLegible','itemsText','total','base','iva','pago','cambio'];
      const rows = history.map(h => [
        csvEscape(h.id),
        csvEscape(h.fechaISO),
        csvEscape(h.fechaLegible),
        csvEscape(h.itemsText),
        csvEscape(h.total),
        csvEscape(h.base),
        csvEscape(h.iva),
        csvEscape(h.pago),
        csvEscape(h.cambio)
      ].join(','));

      const csv = [headers.join(','), ...rows].join('\n');

      downloadFile(csv, 'text/csv;charset=utf-8;', `lp_tickets_${(new Date()).toISOString().slice(0,10)}.csv`);
    }

    function downloadHistoryJSON(){
      const history = getHistory();
      if (!history.length){ alert('No hay datos para descargar.'); return; }
      const json = JSON.stringify(history, null, 2);
      downloadFile(json, 'application/json;charset=utf-8;', `lp_tickets_${(new Date()).toISOString().slice(0,10)}.json`);
    }

    function csvEscape(val){
      if (val === null || val === undefined) return '';
      const s = String(val);
      // si contiene comas, comillas o saltos, encerramos entre comillas y escapamos comillas con doble comilla
      if (/[,"\n\r]/.test(s)) {
        return '"' + s.replace(/"/g,'""') + '"';
      }
      return s;
    }

    function downloadFile(content, mime, filename){
      const blob = new Blob([content], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* -----------------------------------------
       Copiar al portapapeles (fallback)
       ----------------------------------------- */
    function copyToClipboard(txt){
      if (navigator.clipboard && window.isSecureContext){
        return navigator.clipboard.writeText(txt);
      } else {
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); } catch(e){ console.warn('copy fallback failed', e); }
        ta.remove();
        return Promise.resolve();
      }
    }

    function copyTicketText(){
      if (ticket.length === 0){ alert('No hay productos en el ticket.'); return; }
      const pagoVal = document.getElementById('pagoCliente').value || null;
      const text = generateTicketText(ticket, pagoVal);
      copyToClipboard(text).then(()=> alert('Ticket copiado al portapapeles.'));
    }

    /* -----------------------------------------
       Impresión (RawBT fallback) + Guardado en historial
       ----------------------------------------- */
    function openRawbt(text){
      const encoded = encodeURIComponent(text);
      const candidates = [
        `rawbt:${encoded}`,
        `rawbt:=${encoded}`,
        `rawbt://print?text=${encoded}`,
        `rawbt://?text=${encoded}`
      ];
      for (let i=0;i<candidates.length;i++){
        try { window.location.href = candidates[i]; return; } catch(e){ /* continue */ }
      }
      // Si no funciona redirigir (esquema no registrado), abrimos ventana para copiar/pegar
      const w = window.open('', '_blank');
      if (w){
        w.document.write('<pre style="font-family:monospace;padding:12px;">' + escapeHtml(text) + '</pre>');
        w.document.title = 'Ticket — copiar/pegar';
      } else {
        copyToClipboard(text);
        alert('Texto de ticket copiado al portapapeles (fallback).');
      }
    }

    // Al pulsar imprimir: guarda en historial y luego intenta imprimir
    function onPrintClick(){
      if (ticket.length === 0){ alert('No hay productos seleccionados.'); return; }

      const pagoVal = document.getElementById('pagoCliente').value || null;
      // guardamos en historial
      const entry = saveTicketToHistory(ticket, pagoVal);

      // generar texto y abrir rawbt / fallback
      const text = generateTicketText(ticket, pagoVal);
      openRawbt(text);

      // opcional: reiniciar ticket después de imprimir (si quieres activarlo, descomenta)
      // ticket = []; document.getElementById('pagoCliente').value=''; updateDisplay();
    }

    /* -----------------------------------------
       Helpers
       ----------------------------------------- */
    function escapeHtml(s){
      if (s === null || s === undefined) return '';
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    /* -----------------------------------------
       Inicialización
       ----------------------------------------- */
    function init(){
      updateDisplay();
      renderHistory();
    }

    init();
  </script>
</body>
</html>
